---- DROP PROCEDURE SP_IFRS_STOP_PROCESS;

CREATE OR REPLACE PROCEDURE SP_IFRS_STOP_PROCESS(
    IN P_RUNID VARCHAR(100) DEFAULT 'SYSTEMS',
    IN P_DOWNLOAD_DATE DATE DEFAULT NULL)
LANGUAGE PLPGSQL AS $$
DECLARE
	V_PROCESS_ID VARCHAR(100);
    V_CURRDATE DATE; 
BEGIN

    IF P_DOWNLOAD_DATE IS NULL 
    THEN
        SELECT
            CURRDATE INTO V_CURRDATE
        FROM
            IFRS_PRC_DATE;
    ELSE        
        V_CURRDATE := P_DOWNLOAD_DATE;
    END IF;

	V_PROCESS_ID := (SELECT PROCESS_ID FROM IFRS_LOGS_PROCESS WHERE DOWNLOAD_DATE = V_CURRDATE AND RUN_ID = P_RUNID ORDER BY PROCESS_DATE DESC LIMIT 1);
    SELECT PG_TERMINATE_BACKEND(PID) 
    FROM PG_STAT_ACTIVITY 
    WHERE PID = V_PROCESS_ID AND PID <> PG_BACKEND_PID() AND DATNAME = 'IFRS9';
END;
$$;